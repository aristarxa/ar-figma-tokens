<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      background: #ffffff;
      color: #000000;
      padding: 12px;
    }

    .header {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }

    .collection-selector {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    label {
      font-weight: 500;
      font-size: 11px;
      color: #333333;
    }

    select, input, button {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 12px;
      font-family: inherit;
      background: #ffffff;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #18a0fb;
    }

    .search-box {
      margin-bottom: 12px;
    }

    .search-box input {
      padding-left: 28px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23999" d="M5 1a4 4 0 0 1 3.2 6.4l2.7 2.7-.7.7-2.7-2.7A4 4 0 1 1 5 1zm0 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>');
      background-repeat: no-repeat;
      background-position: 8px center;
    }

    .tree-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      padding: 4px;
      margin-bottom: 12px;
    }

    .tree-node {
      display: flex;
      align-items: center;
      padding: 4px;
      cursor: pointer;
      border-radius: 3px;
      user-select: none;
    }

    .tree-node:hover {
      background: #f5f5f5;
    }

    .tree-node-indent {
      display: inline-block;
      width: 16px;
    }

    .tree-node-toggle {
      width: 12px;
      height: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
      cursor: pointer;
      color: #666;
      font-size: 10px;
    }

    .tree-node-toggle:empty {
      width: 0;
      margin-right: 8px;
    }

    .tree-node-checkbox {
      margin-right: 6px;
      cursor: pointer;
    }

    .tree-node-icon {
      margin-right: 4px;
      font-size: 12px;
    }

    .tree-node-label {
      flex: 1;
      font-size: 12px;
    }

    .tree-node-variable {
      color: #000000;
    }

    .tree-node-group {
      color: #666666;
      font-weight: 500;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    button {
      padding: 8px 12px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: #0d8eeb;
    }

    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999999;
    }

    .tree-container::-webkit-scrollbar {
      width: 8px;
    }

    .tree-container::-webkit-scrollbar-track {
      background: #f5f5f5;
    }

    .tree-container::-webkit-scrollbar-thumb {
      background: #cccccc;
      border-radius: 4px;
    }

    .tree-container::-webkit-scrollbar-thumb:hover {
      background: #999999;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="collection-selector">
      <label for="collection-select">–ö–æ–ª–ª–µ–∫—Ü–∏—è:</label>
      <select id="collection-select"></select>
    </div>
    
    <div class="search-box">
      <input 
        type="text" 
        id="search-input" 
        placeholder="–ü–æ–∏—Å–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö..."
      />
    </div>
  </div>

  <div class="tree-container" id="tree-container">
    <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="actions">
    <button id="swap-btn" disabled>Swap Collection</button>
  </div>

  <script>
    var currentTree = [];
    var currentVariables = [];
    var collections = [];
    var selectedCollectionId = '';

    var collectionSelect = document.getElementById('collection-select');
    var searchInput = document.getElementById('search-input');
    var treeContainer = document.getElementById('tree-container');
    var swapBtn = document.getElementById('swap-btn');

    window.onload = function() {
      parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
    };

    window.onmessage = function(event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;

      switch (msg.type) {
        case 'init-data':
          collections = msg.collections;
          selectedCollectionId = msg.defaultCollectionId;
          renderCollectionSelector();
          break;

        case 'tree-data':
          currentTree = msg.tree;
          currentVariables = msg.variables;
          renderTree();
          updateSwapButton();
          break;

        case 'error':
          alert('–û—à–∏–±–∫–∞: ' + msg.message);
          break;

        case 'success':
          alert(msg.message);
          break;
      }
    };

    function renderCollectionSelector() {
      collectionSelect.innerHTML = collections.map(function(c) {
        var selected = c.id === selectedCollectionId ? 'selected' : '';
        return '<option value="' + c.id + '" ' + selected + '>' + c.name + ' (' + c.variableCount + ')</option>';
      }).join('');
    }

    function renderTree() {
      if (currentTree.length === 0) {
        treeContainer.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</div>';
        return;
      }

      treeContainer.innerHTML = '';
      for (var i = 0; i < currentTree.length; i++) {
        renderNode(currentTree[i], treeContainer);
      }
    }

    function renderNode(node, container) {
      var div = document.createElement('div');
      div.className = 'tree-node';
      div.setAttribute('data-node-id', node.id);

      for (var i = 0; i < node.level; i++) {
        var indent = document.createElement('span');
        indent.className = 'tree-node-indent';
        div.appendChild(indent);
      }

      var toggle = document.createElement('span');
      toggle.className = 'tree-node-toggle';
      if (node.type === 'group') {
        toggle.textContent = node.collapsed ? '‚ñ∂' : '‚ñº';
        toggle.onclick = function(e) {
          e.stopPropagation();
          parent.postMessage({ pluginMessage: { type: 'toggle-group', path: node.id } }, '*');
        };
      }
      div.appendChild(toggle);

      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'tree-node-checkbox';
      checkbox.checked = node.checked;
      checkbox.indeterminate = node.indeterminate;
      checkbox.onclick = function(e) {
        e.stopPropagation();
        toggleNodeCheck(node.id, !node.checked);
      };
      div.appendChild(checkbox);

      if (node.type === 'variable') {
        var variable = currentVariables.find(function(v) { return v.id === node.variableId; });
        if (variable) {
          var icon = document.createElement('span');
          icon.className = 'tree-node-icon';
          icon.textContent = getTypeIcon(variable.resolvedType);
          div.appendChild(icon);
        }
      } else {
        var icon = document.createElement('span');
        icon.className = 'tree-node-icon';
        icon.textContent = 'üìÅ';
        div.appendChild(icon);
      }

      var label = document.createElement('span');
      label.className = 'tree-node-label tree-node-' + node.type;
      label.textContent = node.name;
      div.appendChild(label);

      container.appendChild(div);

      if (node.type === 'group' && !node.collapsed && node.children) {
        for (var j = 0; j < node.children.length; j++) {
          renderNode(node.children[j], container);
        }
      }
    }

    function toggleNodeCheck(nodeId, checked) {
      currentTree = updateTreeNodeChecked(currentTree, nodeId, checked);
      renderTree();
      updateSwapButton();
    }

    function updateTreeNodeChecked(tree, nodeId, checked) {
      var result = [];
      for (var i = 0; i < tree.length; i++) {
        var node = tree[i];
        if (node.id === nodeId) {
          var updated = Object.assign({}, node, { checked: checked, indeterminate: false });
          if (node.children) {
            updated.children = updateAllChildren(node.children, checked);
          }
          result.push(updated);
        } else if (node.children) {
          var updatedChildren = updateTreeNodeChecked(node.children, nodeId, checked);
          var checkedCount = 0;
          var indeterminateCount = 0;
          
          for (var j = 0; j < updatedChildren.length; j++) {
            if (updatedChildren[j].checked) checkedCount++;
            if (updatedChildren[j].indeterminate) indeterminateCount++;
          }
          
          var updated = Object.assign({}, node, {
            children: updatedChildren,
            checked: checkedCount === updatedChildren.length,
            indeterminate: (checkedCount > 0 && checkedCount < updatedChildren.length) || indeterminateCount > 0
          });
          result.push(updated);
        } else {
          result.push(node);
        }
      }
      return result;
    }

    function updateAllChildren(children, checked) {
      var result = [];
      for (var i = 0; i < children.length; i++) {
        var child = children[i];
        var updated = Object.assign({}, child, {
          checked: checked,
          indeterminate: false,
          children: child.children ? updateAllChildren(child.children, checked) : undefined
        });
        result.push(updated);
      }
      return result;
    }

    function getTypeIcon(type) {
      var icons = {
        'COLOR': 'üé®',
        'FLOAT': 'üî¢',
        'STRING': 'üìù',
        'BOOLEAN': '‚úì'
      };
      return icons[type] || '‚Ä¢';
    }

    function getCheckedVariableIds(tree) {
      var ids = [];
      
      function traverse(nodes) {
        for (var i = 0; i < nodes.length; i++) {
          var node = nodes[i];
          if (node.checked && node.type === 'variable' && node.variableId) {
            ids.push(node.variableId);
          }
          if (node.children) {
            traverse(node.children);
          }
        }
      }
      
      traverse(tree);
      return ids;
    }

    function updateSwapButton() {
      var checkedIds = getCheckedVariableIds(currentTree);
      swapBtn.disabled = checkedIds.length === 0;
      swapBtn.textContent = checkedIds.length > 0 
        ? 'Swap Collection (' + checkedIds.length + ')'
        : 'Swap Collection';
    }

    collectionSelect.onchange = function() {
      selectedCollectionId = collectionSelect.value;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-collection', 
          collectionId: selectedCollectionId 
        } 
      }, '*');
    };

    searchInput.oninput = function() {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'search', 
          query: searchInput.value 
        } 
      }, '*');
    };

    swapBtn.onclick = function() {
      var checkedIds = getCheckedVariableIds(currentTree);
      if (checkedIds.length === 0) return;

      var targetCollections = collections.filter(function(c) { 
        return c.id !== selectedCollectionId; 
      });
      
      if (targetCollections.length === 0) {
        alert('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞');
        return;
      }

      var options = targetCollections.map(function(c, i) {
        return (i + 1) + '. ' + c.name + ' (' + c.variableCount + ' –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)';
      }).join('\n');

      var choice = prompt(
        '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ (–≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä):\n' + options,
        '1'
      );

      if (!choice) return;

      var index = parseInt(choice) - 1;
      if (index < 0 || index >= targetCollections.length) {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
        return;
      }

      var targetCollectionId = targetCollections[index].id;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'swap-collection',
          variableIds: checkedIds,
          targetCollectionId: targetCollectionId
        } 
      }, '*');
    };
  </script>
</body>
</html>
