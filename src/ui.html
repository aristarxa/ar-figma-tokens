<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      background: #ffffff;
      color: #000000;
      padding: 12px;
    }

    .header {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }

    .collection-selector {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    label {
      font-weight: 500;
      font-size: 11px;
      color: #333333;
    }

    select, input, button {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 12px;
      font-family: inherit;
      background: #ffffff;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #18a0fb;
    }

    .search-box {
      margin-bottom: 12px;
    }

    .search-box input {
      padding-left: 28px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23999" d="M5 1a4 4 0 0 1 3.2 6.4l2.7 2.7-.7.7-2.7-2.7A4 4 0 1 1 5 1zm0 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>');
      background-repeat: no-repeat;
      background-position: 8px center;
    }

    .tree-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      padding: 4px;
      margin-bottom: 12px;
    }

    .tree-node {
      display: flex;
      align-items: center;
      padding: 4px;
      cursor: pointer;
      border-radius: 3px;
      user-select: none;
    }

    .tree-node:hover {
      background: #f5f5f5;
    }

    .tree-node-indent {
      display: inline-block;
      width: 16px;
    }

    .tree-node-toggle {
      width: 12px;
      height: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
      cursor: pointer;
      color: #666;
      font-size: 10px;
    }

    .tree-node-toggle:empty {
      width: 0;
      margin-right: 8px;
    }

    .tree-node-checkbox {
      margin-right: 6px;
      cursor: pointer;
    }

    .tree-node-icon {
      margin-right: 4px;
      font-size: 12px;
    }

    .tree-node-label {
      flex: 1;
      font-size: 12px;
    }

    .tree-node-variable {
      color: #000000;
    }

    .tree-node-group {
      color: #666666;
      font-weight: 500;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    button {
      padding: 8px 12px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: #0d8eeb;
    }

    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999999;
    }

    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
    .tree-container::-webkit-scrollbar {
      width: 8px;
    }

    .tree-container::-webkit-scrollbar-track {
      background: #f5f5f5;
    }

    .tree-container::-webkit-scrollbar-thumb {
      background: #cccccc;
      border-radius: 4px;
    }

    .tree-container::-webkit-scrollbar-thumb:hover {
      background: #999999;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="collection-selector">
      <label for="collection-select">–ö–æ–ª–ª–µ–∫—Ü–∏—è:</label>
      <select id="collection-select"></select>
    </div>
    
    <div class="search-box">
      <input 
        type="text" 
        id="search-input" 
        placeholder="–ü–æ–∏—Å–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö..."
      />
    </div>
  </div>

  <div class="tree-container" id="tree-container">
    <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="actions">
    <button id="swap-btn" disabled>Swap Collection</button>
  </div>

  <script>
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    let currentTree = [];
    let currentVariables = [];
    let collections = [];
    let selectedCollectionId = '';

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const collectionSelect = document.getElementById('collection-select');
    const searchInput = document.getElementById('search-input');
    const treeContainer = document.getElementById('tree-container');
    const swapBtn = document.getElementById('swap-btn');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = () => {
      parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–ª–∞–≥–∏–Ω–∞
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      switch (msg.type) {
        case 'init-data':
          collections = msg.collections;
          selectedCollectionId = msg.defaultCollectionId;
          renderCollectionSelector();
          break;

        case 'tree-data':
          currentTree = msg.tree;
          currentVariables = msg.variables;
          renderTree();
          updateSwapButton();
          break;

        case 'error':
          alert('–û—à–∏–±–∫–∞: ' + msg.message);
          break;

        case 'success':
          alert(msg.message);
          break;
      }
    };

    // –†–µ–Ω–¥–µ—Ä —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π
    function renderCollectionSelector() {
      collectionSelect.innerHTML = collections.map(c => 
        `<option value="${c.id}" ${c.id === selectedCollectionId ? 'selected' : ''}>
          ${c.name} (${c.variableCount})
        </option>`
      ).join('');
    }

    // –†–µ–Ω–¥–µ—Ä –¥–µ—Ä–µ–≤–∞
    function renderTree() {
      if (currentTree.length === 0) {
        treeContainer.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</div>';
        return;
      }

      treeContainer.innerHTML = '';
      currentTree.forEach(node => renderNode(node, treeContainer));
    }

    // –†–µ–Ω–¥–µ—Ä —É–∑–ª–∞ –¥–µ—Ä–µ–≤–∞
    function renderNode(node, container) {
      const div = document.createElement('div');
      div.className = 'tree-node';

      // –û—Ç—Å—Ç—É–ø
      for (let i = 0; i < node.level; i++) {
        const indent = document.createElement('span');
        indent.className = 'tree-node-indent';
        div.appendChild(indent);
      }

      // –ò–∫–æ–Ω–∫–∞ —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø)
      const toggle = document.createElement('span');
      toggle.className = 'tree-node-toggle';
      if (node.type === 'group') {
        toggle.textContent = node.collapsed ? '‚ñ∂' : '‚ñº';
        toggle.onclick = (e) => {
          e.stopPropagation();
          parent.postMessage({ pluginMessage: { type: 'toggle-group', path: node.id } }, '*');
        };
      }
      div.appendChild(toggle);

      // –ß–µ–∫–±–æ–∫—Å
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'tree-node-checkbox';
      checkbox.checked = node.checked;
      checkbox.indeterminate = node.indeterminate;
      checkbox.onclick = (e) => {
        e.stopPropagation();
        toggleNodeCheck(node.id, !node.checked);
      };
      div.appendChild(checkbox);

      // –ò–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞
      if (node.type === 'variable') {
        const variable = currentVariables.find(v => v.id === node.variableId);
        if (variable) {
          const icon = document.createElement('span');
          icon.className = 'tree-node-icon';
          icon.textContent = getTypeIcon(variable.resolvedType);
          div.appendChild(icon);
        }
      } else {
        const icon = document.createElement('span');
        icon.className = 'tree-node-icon';
        icon.textContent = 'üìÅ';
        div.appendChild(icon);
      }

      // –ù–∞–∑–≤–∞–Ω–∏–µ
      const label = document.createElement('span');
      label.className = `tree-node-label tree-node-${node.type}`;
      label.textContent = node.name;
      div.appendChild(label);

      container.appendChild(div);

      // –†–µ–Ω–¥–µ—Ä –¥–µ—Ç–µ–π (–µ—Å–ª–∏ –Ω–µ —Å—Ö–ª–æ–ø–Ω—É—Ç–æ)
      if (node.type === 'group' && !node.collapsed && node.children) {
        node.children.forEach(child => renderNode(child, container));
      }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞
    function toggleNodeCheck(nodeId, checked) {
      currentTree = updateTreeNodeChecked(currentTree, nodeId, checked);
      renderTree();
      updateSwapButton();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ –≤ –¥–µ—Ä–µ–≤–µ
    function updateTreeNodeChecked(tree, nodeId, checked) {
      return tree.map(node => {
        if (node.id === nodeId) {
          const updated = { ...node, checked, indeterminate: false };
          if (node.children) {
            updated.children = updateAllChildren(node.children, checked);
          }
          return updated;
        }

        if (node.children) {
          const updatedChildren = updateTreeNodeChecked(node.children, nodeId, checked);
          const checkedCount = updatedChildren.filter(c => c.checked).length;
          const indeterminateCount = updatedChildren.filter(c => c.indeterminate).length;
          
          return {
            ...node,
            children: updatedChildren,
            checked: checkedCount === updatedChildren.length,
            indeterminate: (checkedCount > 0 && checkedCount < updatedChildren.length) || indeterminateCount > 0
          };
        }

        return node;
      });
    }

    function updateAllChildren(children, checked) {
      return children.map(child => ({
        ...child,
        checked,
        indeterminate: false,
        children: child.children ? updateAllChildren(child.children, checked) : undefined
      }));
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Ç–∏–ø–∞
    function getTypeIcon(type) {
      const icons = {
        'COLOR': 'üé®',
        'FLOAT': 'üî¢',
        'STRING': 'üìù',
        'BOOLEAN': '‚úì'
      };
      return icons[type] || '‚Ä¢';
    }

    // –°–±–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ID
    function getCheckedVariableIds(tree) {
      const ids = [];
      
      function traverse(nodes) {
        for (const node of nodes) {
          if (node.checked && node.type === 'variable' && node.variableId) {
            ids.push(node.variableId);
          }
          if (node.children) {
            traverse(node.children);
          }
        }
      }
      
      traverse(tree);
      return ids;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Swap
    function updateSwapButton() {
      const checkedIds = getCheckedVariableIds(currentTree);
      swapBtn.disabled = checkedIds.length === 0;
      swapBtn.textContent = checkedIds.length > 0 
        ? `Swap Collection (${checkedIds.length})`
        : 'Swap Collection';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    collectionSelect.onchange = () => {
      selectedCollectionId = collectionSelect.value;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-collection', 
          collectionId: selectedCollectionId 
        } 
      }, '*');
    };

    searchInput.oninput = () => {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'search', 
          query: searchInput.value 
        } 
      }, '*');
    };

    swapBtn.onclick = () => {
      const checkedIds = getCheckedVariableIds(currentTree);
      if (checkedIds.length === 0) return;

      // –í—ã–±–æ—Ä —Ü–µ–ª–µ–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
      const targetCollections = collections.filter(c => c.id !== selectedCollectionId);
      if (targetCollections.length === 0) {
        alert('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞');
        return;
      }

      const options = targetCollections.map((c, i) => 
        `${i + 1}. ${c.name} (${c.variableCount} –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)`
      ).join('\n');

      const choice = prompt(
        `–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ (–≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä):\n${options}`,
        '1'
      );

      if (!choice) return;

      const index = parseInt(choice) - 1;
      if (index < 0 || index >= targetCollections.length) {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
        return;
      }

      const targetCollectionId = targetCollections[index].id;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'swap-collection',
          variableIds: checkedIds,
          targetCollectionId
        } 
      }, '*');
    };
  </script>
</body>
</html>
